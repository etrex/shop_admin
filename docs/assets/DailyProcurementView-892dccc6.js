import{D as ne,_ as de,G as ie,s as oe,p as ue,v as H,r as P,H as ce,o as pe,I as me,a as y,b as f,d as x,h as i,g as w,w as t,F as D,e,B as V,m as d,i as o,f as E,u as _,E as z}from"./index-e1c6c1fc.js";const Se=ne("procurement",{state:()=>({procurementSuggestions:[{id:"P001",name:"法國波爾多紅酒 2018",currentStock:0,price:2580,isJIT:!0,suppliers:["S001","S002"],selectedSupplierId:"S001",safetyStock:0,last30DaysSales:24,incomingStock:0,purchaseQty:0},{id:"P002",name:"意大利基安蒂紅酒 2019",currentStock:0,price:1980,isJIT:!0,suppliers:["S002"],selectedSupplierId:"S002",safetyStock:0,last30DaysSales:18,incomingStock:0,purchaseQty:0},{id:"P003",name:"西班牙里奧哈紅酒 2017",currentStock:0,price:2180,isJIT:!0,suppliers:["S002"],selectedSupplierId:"S002",safetyStock:0,last30DaysSales:15,incomingStock:0,purchaseQty:0},{id:"P004",name:"法國勃艮第白酒 2020",currentStock:5,price:2380,isJIT:!1,suppliers:["S001"],selectedSupplierId:"S001",safetyStock:6,last30DaysSales:20,incomingStock:0,purchaseQty:0},{id:"P005",name:"意大利白葡萄酒 2021",currentStock:0,price:1680,isJIT:!0,suppliers:["S002"],selectedSupplierId:"S002",safetyStock:0,last30DaysSales:22,incomingStock:0,purchaseQty:0},{id:"P006",name:"德國雷司令白酒 2020",currentStock:0,price:1880,isJIT:!0,suppliers:["S002"],selectedSupplierId:"S002",safetyStock:0,last30DaysSales:16,incomingStock:0,purchaseQty:0},{id:"P007",name:"獺祭 純米大吟釀 45",currentStock:3,price:1580,isJIT:!1,suppliers:["S003"],selectedSupplierId:"S003",safetyStock:6,last30DaysSales:36,incomingStock:0,purchaseQty:0},{id:"P008",name:"久保田 千寿",currentStock:0,price:1280,isJIT:!0,suppliers:["S003"],selectedSupplierId:"S003",safetyStock:0,last30DaysSales:24,incomingStock:0,purchaseQty:0},{id:"P009",name:"出羽桜 純米大吟釀",currentStock:0,price:1480,isJIT:!0,suppliers:["S003"],selectedSupplierId:"S003",safetyStock:0,last30DaysSales:20,incomingStock:0,purchaseQty:0},{id:"P010",name:"八海山 特別本醸造",currentStock:0,price:980,isJIT:!0,suppliers:["S003"],selectedSupplierId:"S003",safetyStock:0,last30DaysSales:30,incomingStock:0,purchaseQty:0}],boxCompletionItems:[{id:"P005",name:"法國波爾多紅酒 2019",currentStock:5,price:2680,suppliers:["S001"],selectedSupplierId:"S001",boxSize:12,purchaseQty:0},{id:"P006",name:"義大利紅酒 2020",currentStock:3,price:1980,suppliers:["S002"],selectedSupplierId:"S002",boxSize:6,purchaseQty:0}],suppliers:[{id:"S001",name:"法國酒商",phone:"02-2345-6789",paymentTerm:"月結30天"},{id:"S002",name:"義大利酒商",phone:"02-3456-7890",paymentTerm:"月結45天"},{id:"S003",name:"日本酒商",phone:"02-4567-8901",paymentTerm:"月結60天"}],selectedOrders:[],currentStep:1}),getters:{filteredSuggestions:u=>{const c=new Map;return u.selectedOrders.forEach(a=>{a.products.forEach(l=>{const S=c.get(l.id)||0;c.set(l.id,S+l.quantity)})}),u.procurementSuggestions.filter(a=>c.has(a.id)).map(a=>{const l=c.get(a.id)||0,S=a.currentStock-l,b=S<0?Math.abs(S):0;return a.purchaseQty===0&&(a.purchaseQty=b),{...a,orderedQty:l,suggestedQty:b}})},activeSuppliers:u=>{const c=new Set;return u.procurementSuggestions.forEach(a=>{a.selectedSupplierId&&a.purchaseQty>0&&c.add(a.selectedSupplierId)}),u.boxCompletionItems.forEach(a=>{a.selectedSupplierId&&a.purchaseQty>0&&c.add(a.selectedSupplierId)}),u.suppliers.filter(a=>c.has(a.id))},itemSuppliers:u=>c=>u.suppliers.filter(a=>c.suppliers.includes(a.id)),orderedQuantity:u=>c=>{let a=0;return u.selectedOrders.forEach(l=>{l.products.forEach(S=>{S.id===c&&(a+=S.quantity)})}),a},suggestedQuantity:u=>c=>{const a=u.procurementSuggestions.find(b=>b.id===c);if(!a)return 0;const l=u.selectedOrders.reduce((b,$)=>{const T=$.products.find(v=>v.id===c);return b+(T?T.quantity:0)},0),S=a.currentStock-l;return S<0?Math.abs(S):0},supplierBoxItems:u=>c=>u.boxCompletionItems.filter(a=>a.selectedSupplierId===c)},actions:{setSelectedOrders(u){this.selectedOrders=u,this.procurementSuggestions.forEach(a=>{a.purchaseQty=0});const c=new Map;u.forEach(a=>{a.products.forEach(l=>{const S=c.get(l.id)||0;c.set(l.id,S+l.quantity)})}),this.procurementSuggestions.filter(a=>c.has(a.id)).forEach(a=>{const l=c.get(a.id)||0,S=a.currentStock-l,b=S<0?Math.abs(S):0;a.purchaseQty=b})},setCurrentStep(u){this.currentStep=u},updatePurchaseQuantity(u,c){const a=this.procurementSuggestions.find(l=>l.id===u);a&&(a.purchaseQty=c)},updateSelectedSupplier(u,c){const a=this.procurementSuggestions.find(l=>l.id===u);a&&(a.selectedSupplierId=c)},reset(){this.selectedOrders=[],this.currentStep=1,this.procurementSuggestions.forEach(u=>{u.purchaseQty=0}),this.boxCompletionItems.forEach(u=>{u.purchaseQty=0})},updateBoxItemQuantity(u,c){const a=this.boxCompletionItems.find(l=>l.id===u);a&&(a.purchaseQty=c)}}});const he={class:"daily-procurement"},fe={class:"main-content"},ye={class:"card-header"},_e={class:"actions"},ge={class:"card-header"},be={class:"actions"},ke={class:"card-header"},ve={class:"card-header"},Qe={class:"actions"},Ie={class:"supplier-info"},we={class:"supplier-summary"},xe={class:"summary-item"},Ce={class:"value"},Te={class:"summary-item"},De={class:"amount"},Oe={key:0,class:"box-completion"},Pe={class:"box-items-summary"},Ve={class:"summary-item"},Ee={class:"value"},$e={class:"summary-item"},Ne={class:"amount"},Be={class:"sales-trend"},Je={__name:"DailyProcurementView",setup(u){const c=ie(),a=oe(),l=Se();ue();const S=H(()=>l.currentStep),b=P("");ce(S,m=>{m===3&&l.activeSuppliers.length>0&&(b.value=l.activeSuppliers[0].id)});const $=H(()=>a.getAllOrders.filter(m=>m.status==="confirmed")),T=P(!1),v=P(null),L=m=>{l.setSelectedOrders(m)},G=()=>{if(!M()){z.warning("請至少選擇一筆訂單");return}l.setCurrentStep(2)},M=()=>l.selectedOrders.length>0,R=(m,s)=>{l.updatePurchaseQuantity(m.id,s)},Y=(m,s)=>{l.updateSelectedSupplier(m.id,s)},j=m=>{v.value=m,T.value=!0},K=(m,s)=>{l.updateBoxItemQuantity(m.id,s)},W=()=>{l.activeSuppliers.forEach(m=>{const s=l.filteredSuggestions.filter(h=>h.selectedSupplierId===m.id&&h.purchaseQty>0).map(h=>({id:h.id,name:h.name,purchaseQty:h.purchaseQty,price:h.price}));if(s.length>0){const h=s.reduce((I,C)=>I+C.price*C.purchaseQty,0),p={supplier:{id:m.id,name:m.name},expectedDeliveryDate:q(),totalAmount:h,items:s,relatedOrders:l.selectedOrders};c.createPurchaseOrder(p)&&l.selectedOrders.forEach(I=>{a.updateOrderStatus(I.id,"processing")})}}),z.success("進貨單已建立"),S.value=1,l.reset()},X=()=>{if(!l.filteredSuggestions.some(s=>l.suggestedQuantity(s.id)>0&&s.purchaseQty>0)){z.warning("請至少設定一項商品的採購數量");return}l.setCurrentStep(3)},U=()=>{S.value===3?(b.value="",l.setCurrentStep(2)):S.value===2&&l.setCurrentStep(1)},N=m=>{const s=new Date(m);return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")} ${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}`},q=()=>{const m=new Date;return m.setDate(m.getDate()+1),m.toISOString()},Q=m=>m.toLocaleString(),B=P(null);return pe(async()=>{await me(),B.value&&B.value.toggleAllSelection()}),(m,s)=>{const h=y("el-button"),p=y("el-table-column"),O=y("el-tag"),I=y("el-table"),C=y("el-card"),Z=y("el-option"),ee=y("el-select"),A=y("el-input-number"),g=y("el-descriptions-item"),J=y("el-descriptions"),te=y("el-collapse-item"),se=y("el-collapse"),le=y("el-tab-pane"),ae=y("el-tabs"),F=y("el-empty"),re=y("el-dialog");return f(),x("div",he,[s[19]||(s[19]=i("div",{class:"page-header"},[i("h2",null,"日採購作業")],-1)),i("div",fe,[S.value===1?(f(),w(C,{key:0,class:"full-width"},{header:t(()=>[i("div",ye,[s[3]||(s[3]=i("h3",null,"選擇已確認訂單",-1)),i("div",_e,[e(h,{type:"primary",onClick:G,disabled:!M()},{default:t(()=>s[2]||(s[2]=[d(" 下一步 ")])),_:1},8,["disabled"])])])]),default:t(()=>[e(I,{ref_key:"orderTable",ref:B,data:$.value,onSelectionChange:L},{default:t(()=>[e(p,{type:"selection",width:"55"}),e(p,{prop:"id",label:"訂單編號",width:"120"}),e(p,{prop:"createdAt",label:"建立時間",width:"160"},{default:t(({row:n})=>[d(o(N(n.createdAt)),1)]),_:1}),e(p,{prop:"customer.name",label:"客戶名稱",width:"120"}),e(p,{label:"商品"},{default:t(({row:n})=>[(f(!0),x(D,null,E(n.products,r=>(f(),w(O,{key:r.id,size:"small",class:"product-tag"},{default:t(()=>[d(o(r.name)+" x "+o(r.quantity),1)]),_:2},1024))),128))]),_:1}),e(p,{prop:"total",label:"總金額",width:"120"},{default:t(({row:n})=>[d(" NT$ "+o(Q(n.total)),1)]),_:1})]),_:1},8,["data"])]),_:1})):S.value===2?(f(),x(D,{key:1},[e(C,{class:"suggestion-list"},{header:t(()=>[i("div",ge,[s[6]||(s[6]=i("h3",null,"採購建議",-1)),i("div",be,[e(h,{onClick:U},{default:t(()=>s[4]||(s[4]=[d("上一步")])),_:1}),e(h,{type:"primary",onClick:X},{default:t(()=>s[5]||(s[5]=[d("下一步")])),_:1})])])]),default:t(()=>[e(I,{data:_(l).filteredSuggestions,style:{width:"100%"}},{default:t(()=>[e(p,{prop:"id",label:"商品編號",width:"120"}),e(p,{prop:"name",label:"商品名稱"},{default:t(({row:n})=>[d(o(n.name)+" ",1),n.isJIT?(f(),w(O,{key:0,size:"small"},{default:t(()=>s[7]||(s[7]=[d("JIT")])),_:1})):V("",!0)]),_:1}),e(p,{prop:"currentStock",label:"目前庫存",width:"100"}),e(p,{label:"訂單需求",width:"100"},{default:t(({row:n})=>[d(o(_(l).orderedQuantity(n.id)),1)]),_:1}),e(p,{label:"建議數量",width:"100"},{default:t(({row:n})=>[d(o(_(l).suggestedQuantity(n.id)),1)]),_:1}),e(p,{label:"供應商",width:"150"},{default:t(({row:n})=>[e(ee,{modelValue:n.selectedSupplierId,"onUpdate:modelValue":r=>n.selectedSupplierId=r,size:"small",onChange:r=>Y(n,r)},{default:t(()=>[(f(!0),x(D,null,E(_(l).itemSuppliers(n),r=>(f(),w(Z,{key:r.id,label:r.name,value:r.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(p,{prop:"purchaseQty",label:"採購數量",width:"120"},{default:t(({row:n})=>[e(A,{modelValue:n.purchaseQty,"onUpdate:modelValue":r=>n.purchaseQty=r,min:0,max:999,size:"small",onChange:r=>R(n,r)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(p,{label:"操作",width:"120"},{default:t(({row:n})=>[e(h,{type:"primary",link:"",onClick:r=>j(n)},{default:t(()=>s[8]||(s[8]=[d(" 詳情 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),e(C,{class:"order-details"},{header:t(()=>[i("div",ke,[s[9]||(s[9]=i("h3",null,"訂單明細",-1)),e(O,{type:"success"},{default:t(()=>[d(o(_(l).selectedOrders.length)+" 筆訂單",1)]),_:1})])]),default:t(()=>[e(se,null,{default:t(()=>[(f(!0),x(D,null,E(_(l).selectedOrders,n=>(f(),w(te,{key:n.id,title:n.id},{default:t(()=>[e(J,{column:2,border:"",size:"small"},{default:t(()=>[e(g,{label:"客戶名稱"},{default:t(()=>[d(o(n.customer.name),1)]),_:2},1024),e(g,{label:"訂單金額"},{default:t(()=>[d(" NT$ "+o(Q(n.total)),1)]),_:2},1024),e(g,{label:"建立時間"},{default:t(()=>[d(o(N(n.createdAt)),1)]),_:2},1024),e(g,{label:"付款方式"},{default:t(()=>[d(o(n.payment.method==="online"?"線上付款":"貨到付款"),1)]),_:2},1024)]),_:2},1024),e(I,{data:n.products,style:{width:"100%","margin-top":"12px"}},{default:t(()=>[e(p,{prop:"name",label:"商品名稱"}),e(p,{prop:"quantity",label:"數量",width:"100"}),e(p,{prop:"price",label:"單價",width:"120"},{default:t(({row:r})=>[d(" NT$ "+o(Q(r.price)),1)]),_:1}),e(p,{label:"小計",width:"120"},{default:t(({row:r})=>[d(" NT$ "+o(Q(r.price*r.quantity)),1)]),_:1})]),_:2},1032,["data"])]),_:2},1032,["title"]))),128))]),_:1})]),_:1})],64)):S.value===3?(f(),w(C,{key:2,class:"full-width"},{header:t(()=>[i("div",ve,[s[12]||(s[12]=i("h3",null,"進貨單預覽",-1)),i("div",Qe,[e(h,{onClick:U},{default:t(()=>s[10]||(s[10]=[d("上一步")])),_:1}),e(h,{type:"primary",onClick:W},{default:t(()=>s[11]||(s[11]=[d("確認送出")])),_:1})])])]),default:t(()=>[_(l).activeSuppliers.length>0?(f(),w(ae,{key:0,modelValue:b.value,"onUpdate:modelValue":s[0]||(s[0]=n=>b.value=n)},{default:t(()=>[(f(!0),x(D,null,E(_(l).activeSuppliers,n=>(f(),w(le,{key:n.id,label:n.name,name:n.id},{default:t(()=>[i("div",Ie,[e(J,{column:2,border:"",size:"small"},{default:t(()=>[e(g,{label:"供應商編號"},{default:t(()=>[d(o(n.id),1)]),_:2},1024),e(g,{label:"聯絡電話"},{default:t(()=>[d(o(n.phone),1)]),_:2},1024),e(g,{label:"預計到貨"},{default:t(()=>[d(o(N(q())),1)]),_:1}),e(g,{label:"付款條件"},{default:t(()=>[d(o(n.paymentTerm),1)]),_:2},1024)]),_:2},1024)]),e(I,{data:_(l).filteredSuggestions.filter(r=>r.selectedSupplierId===n.id&&r.purchaseQty>0),style:{width:"100%","margin-top":"16px"}},{default:t(()=>[e(p,{prop:"name",label:"商品名稱"}),e(p,{prop:"purchaseQty",label:"數量",width:"120"}),e(p,{prop:"price",label:"單價",width:"120"},{default:t(({row:r})=>[d(" NT$ "+o(Q(r.price)),1)]),_:1}),e(p,{label:"小計",width:"120"},{default:t(({row:r})=>[d(" NT$ "+o(Q(r.price*r.purchaseQty)),1)]),_:1})]),_:2},1032,["data"]),i("div",we,[i("div",xe,[s[13]||(s[13]=i("span",null,"採購總數：",-1)),i("span",Ce,o(_(l).filteredSuggestions.filter(r=>r.selectedSupplierId===n.id).reduce((r,k)=>r+(k.purchaseQty||0),0))+" 瓶",1)]),i("div",Te,[s[14]||(s[14]=i("span",null,"採購總額：",-1)),i("span",De,"NT$ "+o(Q(_(l).filteredSuggestions.filter(r=>r.selectedSupplierId===n.id).reduce((r,k)=>r+k.price*(k.purchaseQty||0),0))),1)])]),_(l).supplierBoxItems(n.id).length>0?(f(),x("div",Oe,[s[17]||(s[17]=i("h4",null,"湊箱商品",-1)),e(I,{data:_(l).supplierBoxItems(n.id),style:{width:"100%","margin-top":"16px"}},{default:t(()=>[e(p,{prop:"name",label:"商品名稱"}),e(p,{prop:"currentStock",label:"目前庫存",width:"100"}),e(p,{prop:"price",label:"單價",width:"120"},{default:t(({row:r})=>[d(" NT$ "+o(Q(r.price)),1)]),_:1}),e(p,{label:"採購數量",width:"120"},{default:t(({row:r})=>[e(A,{modelValue:r.purchaseQty,"onUpdate:modelValue":k=>r.purchaseQty=k,min:0,max:999,size:"small",onChange:k=>K(r,k)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(p,{label:"小計",width:"120"},{default:t(({row:r})=>[d(" NT$ "+o(Q(r.price*r.purchaseQty)),1)]),_:1})]),_:2},1032,["data"]),i("div",Pe,[i("div",Ve,[s[15]||(s[15]=i("span",null,"湊箱總數：",-1)),i("span",Ee,o(_(l).supplierBoxItems(n.id).reduce((r,k)=>r+(k.purchaseQty||0),0))+" 瓶",1)]),i("div",$e,[s[16]||(s[16]=i("span",null,"湊箱總額：",-1)),i("span",Ne,"NT$ "+o(Q(_(l).supplierBoxItems(n.id).reduce((r,k)=>r+k.price*(k.purchaseQty||0),0))),1)])])])):V("",!0)]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"])):(f(),w(F,{key:1,description:"沒有需要採購的商品"}))]),_:1})):V("",!0)]),e(re,{modelValue:T.value,"onUpdate:modelValue":s[1]||(s[1]=n=>T.value=n),title:"商品詳情",width:"800px"},{default:t(()=>[v.value?(f(),x(D,{key:0},[e(J,{column:2,border:""},{default:t(()=>[e(g,{label:"商品名稱"},{default:t(()=>[d(o(v.value.name),1)]),_:1}),e(g,{label:"商品編號"},{default:t(()=>[d(o(v.value.id),1)]),_:1}),e(g,{label:"目前庫存"},{default:t(()=>[d(o(v.value.currentStock),1)]),_:1}),e(g,{label:"安全庫存"},{default:t(()=>[d(o(v.value.safetyStock),1)]),_:1}),e(g,{label:"近30日銷量"},{default:t(()=>[d(o(v.value.last30DaysSales),1)]),_:1}),e(g,{label:"預計到貨"},{default:t(()=>[d(o(v.value.incomingStock),1)]),_:1})]),_:1}),i("div",Be,[s[18]||(s[18]=i("h4",null,"銷售趨勢",-1)),e(F,{description:"開發中"})])],64)):V("",!0)]),_:1},8,["modelValue"])])}}},Me=de(Je,[["__scopeId","data-v-d58a6574"]]);export{Me as default};
